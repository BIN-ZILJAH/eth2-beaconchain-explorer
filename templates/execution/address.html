{{ define "js" }}
<script>
  function setupInfiniteScrollTable(tableDivId, loadingIndicatorDivId, endpoint) {
    var currentToken = ''
    var previousToken = ''

    var isLoading = false

    const infLoading = document.getElementById(loadingIndicatorDivId)

    const getData = async (token) => {
      try {
        const res = await fetch(`${window.location.pathname}/${endpoint}?pageToken=${encodeURI(token)}`)
        const data = await res.json()

        console.log('got data: ', data)

        if (data && data.data && data.pagingToken && data.pagingToken.length) {
          previousToken = currentToken
          currentToken = data.pagingToken
          console.log('setting new pagetoken:\n', "new:", currentToken, '\n', "pre:", previousToken)

          // udpate the table
          for (let i = 0; i < data.data.length; i++) {
            const row = data.data[i];
            for (let j = 0; j < data.data[i].length; j++) {
              const col = data.data[i][j]
              const el = document.createElement('div')
              el.classList.add('border-top')
              el.classList.add('p-2')
              el.innerHTML = col
              infLoading.insertAdjacentElement("beforebegin", el)
            }
          }
        } else {
          console.log("removing")
            infLoading.remove()
        }
        isLoading = false
      } catch (err) {
        console.error("error getting data: ", err)
        isLoading = false
      }
    }
    let optionsScroll = {
      root: document.getElementById(tableDivId),
      rootMargin: '5px',
      threshold: 0
    }
    const handleTableEnd = (entries, observer) => {
      for (let i = 0; i < entries.length; i++) {
        const entry = entries[i];
        if (entry.isIntersecting) {
          console.log('intersecting');
          if (!isLoading) {
            console.log('paging token', currentToken)
            isLoading = true
            getData(currentToken)
          }
        }
      }
    }
    let observerScroll = new IntersectionObserver(handleTableEnd, optionsScroll)
    let lastElement = document.getElementById(loadingIndicatorDivId)
    observerScroll.observe(lastElement)

  }

  setupInfiniteScrollTable('transactions-table', 'transactions-table-inf-scroll', 'transactions')
  setupInfiniteScrollTable('internal-transactions-table', 'internal-transactions-table-inf-scroll', 'internalTxns')
  setupInfiniteScrollTable('erc20-table', 'erc20-table-inf-scroll', 'erc20')



</script>
{{ end }}
{{ define "css" }}
<style>
  .border-bottom-radius-0 {
    border-bottom-left-radius: 0px !important;
    border-bottom-right-radius: 0px !important;
  }
</style>
<style>
  .dataTables_scrollBody {
    height: 100%;
  }

  /* #transactions-table div {
      --ease-elastic-1:cubic-bezier(.5,.75,.75,1.25);
      --ease-elastic-2: cubic-bezier(.5,1,.75,1.25);
      --ease-elastic-3: cubic-bezier(.5,1.25,.75,1.25);
      aspect-ratio: 1;
      transform: scaleX(calc(0.85 + (var(--shown, 1) * 0.15)));
      transition: all 0.3s var(--ease-elastic-1);
    } */
</style>
{{ end }}
{{ define "content" }}
<div class="container mt-2">
  <div class="d-md-flex py-2 my-2 justify-content-md-between">
    <h1 class="h4 mb-1 mb-md-0"><i class="fas fa-address-book mr-2"></i>{{ .Data.Address }} <a
        style="width: 1rem; height: 1rem;" target="_blank" href="https://etherscan.io/address/{{.Data.Address}}"><i
          class="fas fa-external-link-alt"></i></a></h1>
  </div>
  <div class="card">
    <div class="card-header p-0">
      {{ template "AddressTabs" }}
    </div>
    <div class="card-body px-0 py-0">
      <div class="tab-content" id="address-tab-content">
        <div class="tab-pane fade show active" id="transactions" role="tabpanel" aria-labelledby="transaction-tab">
          {{ template "AddressTransactionsTableGrid" }}
        </div>
        <div class="tab-pane fade" id="internalTxns" role="tabpanel" aria-labelledby="internalTxns-tab">
          {{ template "AddressInternalTransactionsTableGrid" }}
        </div>
        <div class="tab-pane fade" id="erc20Txns" role="tabpanel" aria-labelledby="erc20Txns-tab">
          {{ template "AddressErc20TransactionsTableGrid" }}
        </div>
      </div>
    </div>
  </div>
</div>
{{ end }}

{{ define "AddressTabs" }}
<ul class="nav nav-pills border-0 border-bottom-0" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link border-bottom-radius-0 active" href="#transactions" id="transaction-tab" data-toggle="tab"
      role="tab" aria-controls="transactions" aria-selected="true">Transactions</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link border-bottom-radius-0" href="#internalTxns" id="internalTxns-tab" data-toggle="tab" role="tab"
      aria-controls="internalTxns" aria-selected="false">Internal Txns</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link border-bottom-radius-0" href="#erc20Txns" id="erc20Txns-tab" data-toggle="tab" role="tab"
      aria-controls="erc20Txns" aria-selected="false">Erc20 Token Txns</a>
  </li>
</ul>
{{ end }}

{{ define "AddressTransactionsTableGrid" }}
<div id="transactions-table"
  style="display: grid; grid-template-columns: repeat(6, minmax(auto, 1fr)); max-height: 800px; overflow: auto;">
  <div class="h5 mb-0 p-2 bg-light">Hash</div>
  <div class="h5 mb-0 p-2 bg-light">Age</div>
  <div class="h5 mb-0 p-2 bg-light">Number</div>
  <div class="h5 mb-0 p-2 bg-light">From</div>
  <div class="h5 mb-0 p-2 bg-light">To</div>
  <div class="h5 mb-0 p-2 bg-light">Value</div>

  <div style="grid-column: 1 / 7;" id="transactions-table-inf-scroll" class="d-flex justify-content-center p-2">
    <span>loading...</span>
  </div>
</div>
{{ end }}


{{ define "AddressInternalTransactionsTableGrid" }}
<div id="internal-transactions-table"
  style="display: grid; grid-template-columns: repeat(6, minmax(auto, 1fr)); max-height: 800px; overflow: auto;">
  <div class="h5 mb-0 p-2 bg-light">Hash</div>
  <div class="h5 mb-0 p-2 bg-light">Age</div>
  <div class="h5 mb-0 p-2 bg-light">From</div>
  <div class="h5 mb-0 p-2 bg-light">To</div>
  <div class="h5 mb-0 p-2 bg-light">Value</div>
  <div class="h5 mb-0 p-2 bg-light">Type</div>

  <div style="grid-column: 1 / 7;" id="internal-transactions-table-inf-scroll"
    class="d-flex justify-content-center p-2">
    <span>loading...</span>
  </div>
</div>
{{ end }}

{{ define "AddressErc20TransactionsTableGrid" }}
<div id="erc20-table"
  style="display: grid; grid-template-columns: repeat(6, minmax(auto, 1fr)); max-height: 800px; overflow: auto;">
  <div class="h5 mb-0 p-2 bg-light">Hash</div>
  <div class="h5 mb-0 p-2 bg-light">Age</div>
  <div class="h5 mb-0 p-2 bg-light">From</div>
  <div class="h5 mb-0 p-2 bg-light">To</div>
  <div class="h5 mb-0 p-2 bg-light">Value</div>
  <div class="h5 mb-0 p-2 bg-light">Token</div>

  <div style="grid-column: 1 / 7;" id="erc20-table-inf-scroll"
    class="d-flex justify-content-center p-2">
    <span>loading...</span>
  </div>
</div>
{{ end }}